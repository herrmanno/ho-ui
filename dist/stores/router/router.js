var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") return Reflect.decorate(decorators, target, key, desc);
    switch (arguments.length) {
        case 2: return decorators.reduceRight(function(o, d) { return (d && d(o)) || o; }, target);
        case 3: return decorators.reduceRight(function(o, d) { return (d && d(target, key)), void 0; }, void 0);
        case 4: return decorators.reduceRight(function(o, d) { return (d && d(target, key, o)) || o; }, desc);
    }
};
var Promise = ho.promise.Promise;
var Router = (function (_super) {
    __extends(Router, _super);
    function Router() {
        _super.call(this);
        this.mapping = null;
        this.actions = ['RouterActions'];
        window.onhashchange = this.onHashChange.bind(this);
    }
    Router.prototype.init = function () {
        return ho.promise.Promise.create(this.onHashChange());
    };
    Router.prototype.onStateChangeRequested = function (data) {
        //get requested state
        var state = this.getStateFromName(data.state);
        var url = this.urlFromState(state.url, data.args);
        //current state and args equals requested state and args -> return
        if (this.data &&
            this.data.state &&
            this.data.state.name === data.state &&
            this.equals(this.data.args, data.args) &&
            url === window.location.hash.substr(1)) {
            return;
        }
        //requested state has an redirect property -> call redirect state
        if (!!state.redirect) {
            state = this.getStateFromName(state.redirect);
        }
        var prom = typeof state.before === 'function' ? state.before(data) : Promise.create(undefined);
        prom
            .then(function () {
            //does the state change request comes from extern e.g. url change in browser window ?
            var extern = !!data.extern;
            this.data = {
                state: state,
                args: data.args,
                extern: extern,
            };
            //------- set url for browser
            var url = this.urlFromState(state.url, data.args);
            this.setUrl(url);
            this.changed();
        }.bind(this), function (data) {
            this.onStateChangeRequested(data);
        }.bind(this));
    };
    Router.prototype.onHashChange = function () {
        var s = this.stateFromUrl(window.location.hash.substr(1));
        var data = {
            state: s.state,
            args: s.args,
            extern: true
        };
        ho.flux.ACTIONS.get(RouterActions).go(data);
    };
    Router.prototype.setUrl = function (url) {
        if (window.location.hash.substr(1) === url)
            return;
        var l = window.onhashchange;
        window.onhashchange = null;
        window.location.hash = url;
        window.onhashchange = l;
    };
    Router.prototype.getStateFromName = function (name) {
        return this.mapping.filter(function (s) {
            return s.name === name;
        })[0];
    };
    Router.prototype.regexFromUrl = function (url) {
        var regex = /:([\w]+)/;
        while (url.match(regex)) {
            url = url.replace(regex, "([^\/]+)");
        }
        return url + '$';
    };
    Router.prototype.argsFromUrl = function (pattern, url) {
        var r = this.regexFromUrl(pattern);
        var names = pattern.match(r).slice(1);
        var values = url.match(r).slice(1);
        var args = {};
        names.forEach(function (name, i) {
            args[name.substr(1)] = values[i];
        });
        return args;
    };
    Router.prototype.stateFromUrl = function (url) {
        var _this = this;
        var s = void 0;
        this.mapping.forEach(function (state) {
            if (s)
                return;
            var r = _this.regexFromUrl(state.url);
            if (url.match(r)) {
                var args = _this.argsFromUrl(state.url, url);
                s = {
                    "state": state.name,
                    "args": args,
                    "extern": false
                };
            }
        });
        if (!s)
            throw "No State found for url " + url;
        return s;
    };
    Router.prototype.urlFromState = function (url, args) {
        var regex = /:([\w]+)/;
        while (url.match(regex)) {
            url = url.replace(regex, function (m) {
                return args[m.substr(1)];
            });
        }
        return url;
    };
    Router.prototype.equals = function (o1, o2) {
        return JSON.stringify(o1) === JSON.stringify(o2);
    };
    Object.defineProperty(Router.prototype, "onStateChangeRequested",
        __decorate([
            ho.flux.Store.on('STATE')
        ], Router.prototype, "onStateChangeRequested", Object.getOwnPropertyDescriptor(Router.prototype, "onStateChangeRequested")));
    return Router;
})(ho.flux.Store);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN0b3Jlcy9yb3V0ZXIvcm91dGVyLnRzIl0sIm5hbWVzIjpbIlJvdXRlciIsIlJvdXRlci5jb25zdHJ1Y3RvciIsIlJvdXRlci5pbml0IiwiUm91dGVyLm9uU3RhdGVDaGFuZ2VSZXF1ZXN0ZWQiLCJSb3V0ZXIub25IYXNoQ2hhbmdlIiwiUm91dGVyLnNldFVybCIsIlJvdXRlci5nZXRTdGF0ZUZyb21OYW1lIiwiUm91dGVyLnJlZ2V4RnJvbVVybCIsIlJvdXRlci5hcmdzRnJvbVVybCIsIlJvdXRlci5zdGF0ZUZyb21VcmwiLCJSb3V0ZXIudXJsRnJvbVN0YXRlIiwiUm91dGVyLmVxdWFscyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFDQSxJQUFPLE9BQU8sR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQztBQW1DcEM7SUFBcUJBLDBCQUEwQkE7SUFLOUNBO1FBQ0NDLGlCQUFPQSxDQUFDQTtRQUpDQSxZQUFPQSxHQUFpQkEsSUFBSUEsQ0FBQ0E7UUFDdkNBLFlBQU9BLEdBQUdBLENBQUNBLGVBQWVBLENBQUNBLENBQUNBO1FBSTNCQSxNQUFNQSxDQUFDQSxZQUFZQSxHQUFHQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtJQUNwREEsQ0FBQ0E7SUFFTUQscUJBQUlBLEdBQVhBO1FBQ0NFLE1BQU1BLENBQUNBLEVBQUVBLENBQUNBLE9BQU9BLENBQUNBLE9BQU9BLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFlBQVlBLEVBQUVBLENBQUNBLENBQUNBO0lBQ3ZEQSxDQUFDQTtJQUdTRix1Q0FBc0JBLEdBRGhDQSxVQUNpQ0EsSUFBZ0JBO1FBQ2hERyxBQUNBQSxxQkFEcUJBO1lBQ2pCQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxnQkFBZ0JBLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1FBQzlDQSxJQUFJQSxHQUFHQSxHQUFHQSxJQUFJQSxDQUFD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SkNBLEVBeEpvQixFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssRUF3SmpDIiwiZmlsZSI6InN0b3Jlcy9yb3V0ZXIvcm91dGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCBQcm9taXNlID0gaG8ucHJvbWlzZS5Qcm9taXNlO1xyXG5cclxuaW50ZXJmYWNlIElTdGF0ZSB7XHJcblx0bmFtZTogc3RyaW5nO1xyXG5cdHVybDogc3RyaW5nO1xyXG5cdHJlZGlyZWN0Pzogc3RyaW5nO1xyXG5cdGJlZm9yZT86IChkYXRhOiBJUm91dGVEYXRhKT0+UHJvbWlzZTxhbnksIGFueT47XHJcblx0dmlldz86IEFycmF5PElWaWV3U3RhdGU+O1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSVZpZXdTdGF0ZSB7XHJcbiAgICBuYW1lOiBzdHJpbmc7XHJcblx0aHRtbD86IHN0cmluZztcclxuXHRjb21wb25lbnQ/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmludGVyZmFjZSBJU3RhdGVzIHtcclxuICAgIHN0YXRlczogQXJyYXk8SVN0YXRlPjtcclxufVxyXG5cclxuXHJcbi8qKiBEYXRhIHRoYXQgYSBSb3V0ZXIjZ28gdGFrZXMgKi9cclxuaW50ZXJmYWNlIElSb3V0ZURhdGEge1xyXG4gICAgc3RhdGU6IHN0cmluZztcclxuXHRhcmdzOiBhbnk7XHJcblx0ZXh0ZXJuOiBib29sZWFuO1xyXG59XHJcblxyXG4vKiogRGF0YSB0aGF0IFJvdXRlciNjaGFuZ2VzIGVtaXQgdG8gaXRzIGxpc3RlbmVycyAqL1xyXG5pbnRlcmZhY2UgSVJvdXRlckRhdGEge1xyXG4gICAgc3RhdGU6IElTdGF0ZTtcclxuXHRhcmdzOiBhbnk7XHJcblx0ZXh0ZXJuOiBib29sZWFuO1xyXG59XHJcblxyXG5jbGFzcyBSb3V0ZXIgZXh0ZW5kcyBoby5mbHV4LlN0b3JlPElSb3V0ZXJEYXRhPiB7XHJcblxyXG5cdHByb3RlY3RlZCBtYXBwaW5nOkFycmF5PElTdGF0ZT4gPSBudWxsO1xyXG5cdGFjdGlvbnMgPSBbJ1JvdXRlckFjdGlvbnMnXTtcclxuXHJcblx0Y29uc3RydWN0b3IoKSB7XHJcblx0XHRzdXBlcigpO1xyXG5cdFx0d2luZG93Lm9uaGFzaGNoYW5nZSA9IHRoaXMub25IYXNoQ2hhbmdlLmJpbmQodGhpcyk7XHJcblx0fVxyXG5cclxuXHRwdWJsaWMgaW5pdCgpOiBoby5wcm9taXNlLlByb21pc2U8YW55LCBhbnk+IHtcclxuXHRcdHJldHVybiBoby5wcm9taXNlLlByb21pc2UuY3JlYXRlKHRoaXMub25IYXNoQ2hhbmdlKCkpO1xyXG5cdH1cclxuXHJcblx0QGhvLmZsdXguU3RvcmUub24oJ1NUQVRFJylcclxuXHRwcm90ZWN0ZWQgb25TdGF0ZUNoYW5nZVJlcXVlc3RlZChkYXRhOiBJUm91dGVEYXRhKTogdm9pZCB7XHJcblx0XHQvL2dldCByZXF1ZXN0ZWQgc3RhdGVcclxuXHRcdGxldCBzdGF0ZSA9IHRoaXMuZ2V0U3RhdGVGcm9tTmFtZShkYXRhLnN0YXRlKTtcclxuXHRcdGxldCB1cmwgPSB0aGlzLnVybEZyb21TdGF0ZShzdGF0ZS51cmwsIGRhdGEuYXJncyk7XHJcblxyXG5cdFx0Ly9jdXJyZW50IHN0YXRlIGFuZCBhcmdzIGVxdWFscyByZXF1ZXN0ZWQgc3RhdGUgYW5kIGFyZ3MgLT4gcmV0dXJuXHJcblx0XHRpZihcclxuXHRcdFx0dGhpcy5kYXRhICYmXHJcblx0XHRcdHRoaXMuZGF0YS5zdGF0ZSAmJlxyXG5cdFx0XHR0aGlzLmRhdGEuc3RhdGUubmFtZSA9PT0gZGF0YS5zdGF0ZSAmJlxyXG5cdFx0XHR0aGlzLmVxdWFscyh0aGlzLmRhdGEuYXJncywgZGF0YS5hcmdzKSAmJlxyXG5cdFx0XHR1cmwgPT09IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cigxKVxyXG5cdFx0KSB7XHJcblx0XHRcdHJldHVybjtcclxuXHRcdH1cclxuXHJcblxyXG5cclxuXHRcdC8vcmVxdWVzdGVkIHN0YXRlIGhhcyBhbiByZWRpcmVjdCBwcm9wZXJ0eSAtPiBjYWxsIHJlZGlyZWN0IHN0YXRlXHJcblx0XHRpZighIXN0YXRlLnJlZGlyZWN0KSB7XHJcblx0XHRcdHN0YXRlID0gdGhpcy5nZXRTdGF0ZUZyb21OYW1lKHN0YXRlLnJlZGlyZWN0KTtcclxuXHRcdH1cclxuXHJcblxyXG5cdFx0bGV0IHByb20gPSB0eXBlb2Ygc3RhdGUuYmVmb3JlID09PSAnZnVuY3Rpb24nID8gc3RhdGUuYmVmb3JlKGRhdGEpIDogUHJvbWlzZS5jcmVhdGUodW5kZWZpbmVkKTtcclxuXHRcdHByb21cclxuXHRcdC50aGVuKGZ1bmN0aW9uKCkge1xyXG5cclxuXHRcdFx0Ly9kb2VzIHRoZSBzdGF0ZSBjaGFuZ2UgcmVxdWVzdCBjb21lcyBmcm9tIGV4dGVybiBlLmcuIHVybCBjaGFuZ2UgaW4gYnJvd3NlciB3aW5kb3cgP1xyXG5cdFx0XHRsZXQgZXh0ZXJuID0gISEgZGF0YS5leHRlcm47XHJcblxyXG5cdFx0XHR0aGlzLmRhdGEgPSB7XHJcblx0XHRcdFx0c3RhdGU6IHN0YXRlLFxyXG5cdFx0XHRcdGFyZ3M6IGRhdGEuYXJncyxcclxuXHRcdFx0XHRleHRlcm46IGV4dGVybixcclxuXHRcdFx0fTtcclxuXHJcblx0XHRcdC8vLS0tLS0tLSBzZXQgdXJsIGZvciBicm93c2VyXHJcblx0XHRcdHZhciB1cmwgPSB0aGlzLnVybEZyb21TdGF0ZShzdGF0ZS51cmwsIGRhdGEuYXJncyk7XHJcblx0XHRcdHRoaXMuc2V0VXJsKHVybCk7XHJcblxyXG5cdFx0XHR0aGlzLmNoYW5nZWQoKTtcclxuXHJcblx0XHR9LmJpbmQodGhpcyksXHJcblx0XHRmdW5jdGlvbihkYXRhKSB7XHJcblx0XHRcdHRoaXMub25TdGF0ZUNoYW5nZVJlcXVlc3RlZChkYXRhKTtcclxuXHRcdH0uYmluZCh0aGlzKSk7XHJcblxyXG5cdH1cclxuXHJcblx0cHJvdGVjdGVkIG9uSGFzaENoYW5nZSgpOiB2b2lkIHtcclxuXHRcdGxldCBzID0gdGhpcy5zdGF0ZUZyb21Vcmwod2luZG93LmxvY2F0aW9uLmhhc2guc3Vic3RyKDEpKTtcclxuXHJcblx0XHRsZXQgZGF0YSA9IHtcclxuXHRcdFx0c3RhdGU6IHMuc3RhdGUsXHJcblx0XHRcdGFyZ3M6IHMuYXJncyxcclxuXHRcdFx0ZXh0ZXJuOiB0cnVlXHJcblx0XHR9O1xyXG5cclxuXHRcdGhvLmZsdXguQUNUSU9OUy5nZXQoUm91dGVyQWN0aW9ucykuZ28oZGF0YSk7XHJcblxyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBzZXRVcmwodXJsOiBzdHJpbmcpOiB2b2lkIHtcclxuXHRcdGlmKHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cigxKSA9PT0gdXJsKVxyXG5cdFx0XHRyZXR1cm47XHJcblxyXG5cdFx0bGV0IGwgPSB3aW5kb3cub25oYXNoY2hhbmdlO1xyXG5cdFx0d2luZG93Lm9uaGFzaGNoYW5nZSA9IG51bGw7XHJcblx0XHR3aW5kb3cubG9jYXRpb24uaGFzaCA9IHVybDtcclxuXHRcdHdpbmRvdy5vbmhhc2hjaGFuZ2UgPSBsO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBnZXRTdGF0ZUZyb21OYW1lKG5hbWU6IHN0cmluZyk6IElTdGF0ZSB7XHJcblx0XHRyZXR1cm4gdGhpcy5tYXBwaW5nLmZpbHRlcigocyk9PntcclxuXHRcdFx0cmV0dXJuIHMubmFtZSA9PT0gbmFtZVxyXG5cdFx0fSlbMF07XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIHJlZ2V4RnJvbVVybCh1cmw6IHN0cmluZyk6IHN0cmluZyB7XHJcblx0XHR2YXIgcmVnZXggPSAvOihbXFx3XSspLztcclxuXHRcdHdoaWxlKHVybC5tYXRjaChyZWdleCkpIHtcclxuXHRcdFx0dXJsID0gdXJsLnJlcGxhY2UocmVnZXgsIFwiKFteXFwvXSspXCIpO1xyXG5cdFx0fVxyXG5cdFx0cmV0dXJuIHVybCsnJCc7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIGFyZ3NGcm9tVXJsKHBhdHRlcm46IHN0cmluZywgdXJsOiBzdHJpbmcpOiBhbnkge1xyXG5cdFx0bGV0IHIgPSB0aGlzLnJlZ2V4RnJvbVVybChwYXR0ZXJuKTtcclxuXHRcdGxldCBuYW1lcyA9IHBhdHRlcm4ubWF0Y2gocikuc2xpY2UoMSk7XHJcblx0XHRsZXQgdmFsdWVzID0gdXJsLm1hdGNoKHIpLnNsaWNlKDEpO1xyXG5cclxuXHRcdGxldCBhcmdzID0ge307XHJcblx0XHRuYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUsIGkpIHtcclxuXHRcdFx0YXJnc1tuYW1lLnN1YnN0cigxKV0gPSB2YWx1ZXNbaV07XHJcblx0XHR9KTtcclxuXHJcblx0XHRyZXR1cm4gYXJncztcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgc3RhdGVGcm9tVXJsKHVybDogc3RyaW5nKTogSVJvdXRlRGF0YSB7XHJcblx0XHR2YXIgcyA9IHZvaWQgMDtcclxuXHRcdHRoaXMubWFwcGluZy5mb3JFYWNoKChzdGF0ZTogSVN0YXRlKSA9PiB7XHJcblx0XHRcdGlmKHMpXHJcblx0XHRcdFx0cmV0dXJuO1xyXG5cclxuXHRcdFx0dmFyIHIgPSB0aGlzLnJlZ2V4RnJvbVVybChzdGF0ZS51cmwpO1xyXG5cdFx0XHRpZih1cmwubWF0Y2gocikpIHtcclxuXHRcdFx0XHR2YXIgYXJncyA9IHRoaXMuYXJnc0Zyb21Vcmwoc3RhdGUudXJsLCB1cmwpO1xyXG5cdFx0XHRcdHMgPSB7XHJcblx0XHRcdFx0XHRcInN0YXRlXCI6IHN0YXRlLm5hbWUsXHJcblx0XHRcdFx0XHRcImFyZ3NcIjogYXJncyxcclxuXHRcdFx0XHRcdFwiZXh0ZXJuXCI6IGZhbHNlXHJcblx0XHRcdFx0fTtcclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblxyXG5cdFx0aWYoIXMpXHJcblx0XHRcdHRocm93IFwiTm8gU3RhdGUgZm91bmQgZm9yIHVybCBcIit1cmw7XHJcblxyXG5cdFx0cmV0dXJuIHM7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIHVybEZyb21TdGF0ZSh1cmw6IHN0cmluZywgYXJnczogYW55KTogc3RyaW5nIHtcclxuXHRcdGxldCByZWdleCA9IC86KFtcXHddKykvO1xyXG5cdFx0d2hpbGUodXJsLm1hdGNoKHJlZ2V4KSkge1xyXG5cdFx0XHR1cmwgPSB1cmwucmVwbGFjZShyZWdleCwgZnVuY3Rpb24obSkge1xyXG5cdFx0XHRcdHJldHVybiBhcmdzW20uc3Vic3RyKDEpXTtcclxuXHRcdFx0fSk7XHJcblx0XHR9XHJcblx0XHRyZXR1cm4gdXJsO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBlcXVhbHMobzE6IGFueSwgbzI6IGFueSkgOiBib29sZWFuIHtcclxuXHRcdHJldHVybiBKU09OLnN0cmluZ2lmeShvMSkgPT09IEpTT04uc3RyaW5naWZ5KG8yKTtcclxuXHR9XHJcblxyXG59XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==