var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Promise = ho.promise.Promise;
var Router = (function (_super) {
    __extends(Router, _super);
    function Router() {
        _super.call(this);
        this.mapping = null;
        this.actions = ['RouterActions'];
        window.onhashchange = this.onHashChange.bind(this);
    }
    Router.prototype.init = function () {
        var self = this;
        return _super.prototype.init.call(this)
            .then(function () {
            self.onHashChange();
        });
    };
    //@ho.flux.Store.on('STATE') ERRROR: Method gets bound with 'this=Router' but mapping gets defined in subclass
    Router.prototype.onStateChangeRequested = function (data) {
        //get requested state
        var state = this.getStateFromName(data.state);
        var url = this.urlFromState(state.url, data.args);
        //current state and args equals requested state and args -> return
        if (this.data &&
            this.data.state &&
            this.data.state.name === data.state &&
            this.equals(this.data.args, data.args) &&
            url === window.location.hash.substr(1)) {
            return;
        }
        //requested state has an redirect property -> call redirect state
        if (!!state.redirect) {
            state = this.getStateFromName(state.redirect);
        }
        var prom = typeof state.before === 'function' ? state.before(data) : Promise.create(undefined);
        prom
            .then(function () {
            //does the state change request comes from extern e.g. url change in browser window ?
            var extern = !!data.extern;
            this.data = {
                state: state,
                args: data.args,
                extern: extern,
            };
            //------- set url for browser
            var url = this.urlFromState(state.url, data.args);
            this.setUrl(url);
            this.changed();
        }.bind(this), function (data) {
            this.onStateChangeRequested(data);
        }.bind(this));
    };
    Router.prototype.onHashChange = function () {
        var s = this.stateFromUrl(window.location.hash.substr(1));
        var data = {
            state: s.state,
            args: s.args,
            extern: true
        };
        ho.flux.ACTIONS.get(RouterActions).go(data);
    };
    Router.prototype.setUrl = function (url) {
        if (window.location.hash.substr(1) === url)
            return;
        var l = window.onhashchange;
        window.onhashchange = null;
        window.location.hash = url;
        window.onhashchange = l;
    };
    Router.prototype.getStateFromName = function (name) {
        return this.mapping.filter(function (s) {
            return s.name === name;
        })[0];
    };
    Router.prototype.regexFromUrl = function (url) {
        var regex = /:([\w]+)/;
        while (url.match(regex)) {
            url = url.replace(regex, "([^\/]+)");
        }
        return url + '$';
    };
    Router.prototype.argsFromUrl = function (pattern, url) {
        var r = this.regexFromUrl(pattern);
        var names = pattern.match(r).slice(1);
        var values = url.match(r).slice(1);
        var args = {};
        names.forEach(function (name, i) {
            args[name.substr(1)] = values[i];
        });
        return args;
    };
    Router.prototype.stateFromUrl = function (url) {
        var _this = this;
        var s = void 0;
        this.mapping.forEach(function (state) {
            if (s)
                return;
            var r = _this.regexFromUrl(state.url);
            if (url.match(r)) {
                var args = _this.argsFromUrl(state.url, url);
                s = {
                    "state": state.name,
                    "args": args,
                    "extern": false
                };
            }
        });
        if (!s)
            throw "No State found for url " + url;
        return s;
    };
    Router.prototype.urlFromState = function (url, args) {
        var regex = /:([\w]+)/;
        while (url.match(regex)) {
            url = url.replace(regex, function (m) {
                return args[m.substr(1)];
            });
        }
        return url;
    };
    Router.prototype.equals = function (o1, o2) {
        return JSON.stringify(o1) === JSON.stringify(o2);
    };
    return Router;
})(ho.flux.Store);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN0b3Jlcy9yb3V0ZXIvcm91dGVyLnRzIl0sIm5hbWVzIjpbIlJvdXRlciIsIlJvdXRlci5jb25zdHJ1Y3RvciIsIlJvdXRlci5pbml0IiwiUm91dGVyLm9uU3RhdGVDaGFuZ2VSZXF1ZXN0ZWQiLCJSb3V0ZXIub25IYXNoQ2hhbmdlIiwiUm91dGVyLnNldFVybCIsIlJvdXRlci5nZXRTdGF0ZUZyb21OYW1lIiwiUm91dGVyLnJlZ2V4RnJvbVVybCIsIlJvdXRlci5hcmdzRnJvbVVybCIsIlJvdXRlci5zdGF0ZUZyb21VcmwiLCJSb3V0ZXIudXJsRnJvbVN0YXRlIiwiUm91dGVyLmVxdWFscyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsSUFBTyxPQUFPLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUM7QUFtQ3BDO0lBQXFCQSwwQkFBMEJBO0lBSzlDQTtRQUNDQyxpQkFBT0EsQ0FBQ0E7UUFKQ0EsWUFBT0EsR0FBaUJBLElBQUlBLENBQUNBO1FBQ3ZDQSxZQUFPQSxHQUFHQSxDQUFDQSxlQUFlQSxDQUFDQSxDQUFDQTtRQUkzQkEsTUFBTUEsQ0FBQ0EsWUFBWUEsR0FBR0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7SUFDcERBLENBQUNBO0lBRU1ELHFCQUFJQSxHQUFYQTtRQUNDRSxJQUFJQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUVoQkEsTUFBTUEsQ0FBQ0EsZ0JBQUtBLENBQUNBLElBQUlBLFdBQUVBO2FBQ2xCQSxJQUFJQSxDQUFDQTtZQUNMQSxJQUFJQSxDQUFDQSxZQUFZQSxFQUFFQSxDQUFDQTtRQUNyQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDSkEsQ0FBQ0E7SUFFREYsOEdBQThHQTtJQUNwR0EsdUNBQXNCQSxHQUFoQ0EsVUFBaUNBLElBQWdCQTtRQUNoREcsQUFDQUEscUJBRHFCQTtZQUNqQkEsS0FBS0EsR0FBR0EsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxJ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cm91dGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCBQcm9taXNlID0gaG8ucHJvbWlzZS5Qcm9taXNlO1xyXG5cclxuaW50ZXJmYWNlIElTdGF0ZSB7XHJcblx0bmFtZTogc3RyaW5nO1xyXG5cdHVybDogc3RyaW5nO1xyXG5cdHJlZGlyZWN0Pzogc3RyaW5nO1xyXG5cdGJlZm9yZT86IChkYXRhOiBJUm91dGVEYXRhKT0+UHJvbWlzZTxhbnksIGFueT47XHJcblx0dmlldz86IEFycmF5PElWaWV3U3RhdGU+O1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSVZpZXdTdGF0ZSB7XHJcbiAgICBuYW1lOiBzdHJpbmc7XHJcblx0aHRtbD86IHN0cmluZztcclxuXHRjb21wb25lbnQ/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmludGVyZmFjZSBJU3RhdGVzIHtcclxuICAgIHN0YXRlczogQXJyYXk8SVN0YXRlPjtcclxufVxyXG5cclxuXHJcbi8qKiBEYXRhIHRoYXQgYSBSb3V0ZXIjZ28gdGFrZXMgKi9cclxuaW50ZXJmYWNlIElSb3V0ZURhdGEge1xyXG4gICAgc3RhdGU6IHN0cmluZztcclxuXHRhcmdzOiBhbnk7XHJcblx0ZXh0ZXJuOiBib29sZWFuO1xyXG59XHJcblxyXG4vKiogRGF0YSB0aGF0IFJvdXRlciNjaGFuZ2VzIGVtaXQgdG8gaXRzIGxpc3RlbmVycyAqL1xyXG5pbnRlcmZhY2UgSVJvdXRlckRhdGEge1xyXG4gICAgc3RhdGU6IElTdGF0ZTtcclxuXHRhcmdzOiBhbnk7XHJcblx0ZXh0ZXJuOiBib29sZWFuO1xyXG59XHJcblxyXG5jbGFzcyBSb3V0ZXIgZXh0ZW5kcyBoby5mbHV4LlN0b3JlPElSb3V0ZXJEYXRhPiB7XHJcblxyXG5cdHByb3RlY3RlZCBtYXBwaW5nOkFycmF5PElTdGF0ZT4gPSBudWxsO1xyXG5cdGFjdGlvbnMgPSBbJ1JvdXRlckFjdGlvbnMnXTtcclxuXHJcblx0Y29uc3RydWN0b3IoKSB7XHJcblx0XHRzdXBlcigpO1xyXG5cdFx0d2luZG93Lm9uaGFzaGNoYW5nZSA9IHRoaXMub25IYXNoQ2hhbmdlLmJpbmQodGhpcyk7XHJcblx0fVxyXG5cclxuXHRwdWJsaWMgaW5pdCgpOiBoby5wcm9taXNlLlByb21pc2U8YW55LCBhbnk+IHtcclxuXHRcdGxldCBzZWxmID0gdGhpcztcclxuXHJcblx0XHRyZXR1cm4gc3VwZXIuaW5pdCgpXHJcblx0XHQudGhlbigoKSA9PiB7XHJcblx0XHRcdHNlbGYub25IYXNoQ2hhbmdlKCk7XHJcblx0XHR9KTtcclxuXHR9XHJcblxyXG5cdC8vQGhvLmZsdXguU3RvcmUub24oJ1NUQVRFJykgRVJSUk9SOiBNZXRob2QgZ2V0cyBib3VuZCB3aXRoICd0aGlzPVJvdXRlcicgYnV0IG1hcHBpbmcgZ2V0cyBkZWZpbmVkIGluIHN1YmNsYXNzXHJcblx0cHJvdGVjdGVkIG9uU3RhdGVDaGFuZ2VSZXF1ZXN0ZWQoZGF0YTogSVJvdXRlRGF0YSk6IHZvaWQge1xyXG5cdFx0Ly9nZXQgcmVxdWVzdGVkIHN0YXRlXHJcblx0XHRsZXQgc3RhdGUgPSB0aGlzLmdldFN0YXRlRnJvbU5hbWUoZGF0YS5zdGF0ZSk7XHJcblx0XHRsZXQgdXJsID0gdGhpcy51cmxGcm9tU3RhdGUoc3RhdGUudXJsLCBkYXRhLmFyZ3MpO1xyXG5cclxuXHRcdC8vY3VycmVudCBzdGF0ZSBhbmQgYXJncyBlcXVhbHMgcmVxdWVzdGVkIHN0YXRlIGFuZCBhcmdzIC0+IHJldHVyblxyXG5cdFx0aWYoXHJcblx0XHRcdHRoaXMuZGF0YSAmJlxyXG5cdFx0XHR0aGlzLmRhdGEuc3RhdGUgJiZcclxuXHRcdFx0dGhpcy5kYXRhLnN0YXRlLm5hbWUgPT09IGRhdGEuc3RhdGUgJiZcclxuXHRcdFx0dGhpcy5lcXVhbHModGhpcy5kYXRhLmFyZ3MsIGRhdGEuYXJncykgJiZcclxuXHRcdFx0dXJsID09PSB3aW5kb3cubG9jYXRpb24uaGFzaC5zdWJzdHIoMSlcclxuXHRcdCkge1xyXG5cdFx0XHRyZXR1cm47XHJcblx0XHR9XHJcblxyXG5cclxuXHJcblx0XHQvL3JlcXVlc3RlZCBzdGF0ZSBoYXMgYW4gcmVkaXJlY3QgcHJvcGVydHkgLT4gY2FsbCByZWRpcmVjdCBzdGF0ZVxyXG5cdFx0aWYoISFzdGF0ZS5yZWRpcmVjdCkge1xyXG5cdFx0XHRzdGF0ZSA9IHRoaXMuZ2V0U3RhdGVGcm9tTmFtZShzdGF0ZS5yZWRpcmVjdCk7XHJcblx0XHR9XHJcblxyXG5cclxuXHRcdGxldCBwcm9tID0gdHlwZW9mIHN0YXRlLmJlZm9yZSA9PT0gJ2Z1bmN0aW9uJyA/IHN0YXRlLmJlZm9yZShkYXRhKSA6IFByb21pc2UuY3JlYXRlKHVuZGVmaW5lZCk7XHJcblx0XHRwcm9tXHJcblx0XHQudGhlbihmdW5jdGlvbigpIHtcclxuXHJcblx0XHRcdC8vZG9lcyB0aGUgc3RhdGUgY2hhbmdlIHJlcXVlc3QgY29tZXMgZnJvbSBleHRlcm4gZS5nLiB1cmwgY2hhbmdlIGluIGJyb3dzZXIgd2luZG93ID9cclxuXHRcdFx0bGV0IGV4dGVybiA9ICEhIGRhdGEuZXh0ZXJuO1xyXG5cclxuXHRcdFx0dGhpcy5kYXRhID0ge1xyXG5cdFx0XHRcdHN0YXRlOiBzdGF0ZSxcclxuXHRcdFx0XHRhcmdzOiBkYXRhLmFyZ3MsXHJcblx0XHRcdFx0ZXh0ZXJuOiBleHRlcm4sXHJcblx0XHRcdH07XHJcblxyXG5cdFx0XHQvLy0tLS0tLS0gc2V0IHVybCBmb3IgYnJvd3NlclxyXG5cdFx0XHR2YXIgdXJsID0gdGhpcy51cmxGcm9tU3RhdGUoc3RhdGUudXJsLCBkYXRhLmFyZ3MpO1xyXG5cdFx0XHR0aGlzLnNldFVybCh1cmwpO1xyXG5cclxuXHRcdFx0dGhpcy5jaGFuZ2VkKCk7XHJcblxyXG5cdFx0fS5iaW5kKHRoaXMpLFxyXG5cdFx0ZnVuY3Rpb24oZGF0YSkge1xyXG5cdFx0XHR0aGlzLm9uU3RhdGVDaGFuZ2VSZXF1ZXN0ZWQoZGF0YSk7XHJcblx0XHR9LmJpbmQodGhpcykpO1xyXG5cclxuXHR9XHJcblxyXG5cdHByb3RlY3RlZCBvbkhhc2hDaGFuZ2UoKTogdm9pZCB7XHJcblx0XHRsZXQgcyA9IHRoaXMuc3RhdGVGcm9tVXJsKHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cigxKSk7XHJcblxyXG5cdFx0bGV0IGRhdGEgPSB7XHJcblx0XHRcdHN0YXRlOiBzLnN0YXRlLFxyXG5cdFx0XHRhcmdzOiBzLmFyZ3MsXHJcblx0XHRcdGV4dGVybjogdHJ1ZVxyXG5cdFx0fTtcclxuXHJcblx0XHRoby5mbHV4LkFDVElPTlMuZ2V0KFJvdXRlckFjdGlvbnMpLmdvKGRhdGEpO1xyXG5cclxuXHR9XHJcblxyXG5cdHByaXZhdGUgc2V0VXJsKHVybDogc3RyaW5nKTogdm9pZCB7XHJcblx0XHRpZih3aW5kb3cubG9jYXRpb24uaGFzaC5zdWJzdHIoMSkgPT09IHVybClcclxuXHRcdFx0cmV0dXJuO1xyXG5cclxuXHRcdGxldCBsID0gd2luZG93Lm9uaGFzaGNoYW5nZTtcclxuXHRcdHdpbmRvdy5vbmhhc2hjaGFuZ2UgPSBudWxsO1xyXG5cdFx0d2luZG93LmxvY2F0aW9uLmhhc2ggPSB1cmw7XHJcblx0XHR3aW5kb3cub25oYXNoY2hhbmdlID0gbDtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgZ2V0U3RhdGVGcm9tTmFtZShuYW1lOiBzdHJpbmcpOiBJU3RhdGUge1xyXG5cdFx0cmV0dXJuIHRoaXMubWFwcGluZy5maWx0ZXIoKHMpPT57XHJcblx0XHRcdHJldHVybiBzLm5hbWUgPT09IG5hbWVcclxuXHRcdH0pWzBdO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSByZWdleEZyb21VcmwodXJsOiBzdHJpbmcpOiBzdHJpbmcge1xyXG5cdFx0dmFyIHJlZ2V4ID0gLzooW1xcd10rKS87XHJcblx0XHR3aGlsZSh1cmwubWF0Y2gocmVnZXgpKSB7XHJcblx0XHRcdHVybCA9IHVybC5yZXBsYWNlKHJlZ2V4LCBcIihbXlxcL10rKVwiKTtcclxuXHRcdH1cclxuXHRcdHJldHVybiB1cmwrJyQnO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBhcmdzRnJvbVVybChwYXR0ZXJuOiBzdHJpbmcsIHVybDogc3RyaW5nKTogYW55IHtcclxuXHRcdGxldCByID0gdGhpcy5yZWdleEZyb21VcmwocGF0dGVybik7XHJcblx0XHRsZXQgbmFtZXMgPSBwYXR0ZXJuLm1hdGNoKHIpLnNsaWNlKDEpO1xyXG5cdFx0bGV0IHZhbHVlcyA9IHVybC5tYXRjaChyKS5zbGljZSgxKTtcclxuXHJcblx0XHRsZXQgYXJncyA9IHt9O1xyXG5cdFx0bmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lLCBpKSB7XHJcblx0XHRcdGFyZ3NbbmFtZS5zdWJzdHIoMSldID0gdmFsdWVzW2ldO1xyXG5cdFx0fSk7XHJcblxyXG5cdFx0cmV0dXJuIGFyZ3M7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIHN0YXRlRnJvbVVybCh1cmw6IHN0cmluZyk6IElSb3V0ZURhdGEge1xyXG5cdFx0dmFyIHMgPSB2b2lkIDA7XHJcblx0XHR0aGlzLm1hcHBpbmcuZm9yRWFjaCgoc3RhdGU6IElTdGF0ZSkgPT4ge1xyXG5cdFx0XHRpZihzKVxyXG5cdFx0XHRcdHJldHVybjtcclxuXHJcblx0XHRcdHZhciByID0gdGhpcy5yZWdleEZyb21Vcmwoc3RhdGUudXJsKTtcclxuXHRcdFx0aWYodXJsLm1hdGNoKHIpKSB7XHJcblx0XHRcdFx0dmFyIGFyZ3MgPSB0aGlzLmFyZ3NGcm9tVXJsKHN0YXRlLnVybCwgdXJsKTtcclxuXHRcdFx0XHRzID0ge1xyXG5cdFx0XHRcdFx0XCJzdGF0ZVwiOiBzdGF0ZS5uYW1lLFxyXG5cdFx0XHRcdFx0XCJhcmdzXCI6IGFyZ3MsXHJcblx0XHRcdFx0XHRcImV4dGVyblwiOiBmYWxzZVxyXG5cdFx0XHRcdH07XHJcblx0XHRcdH1cclxuXHRcdH0pO1xyXG5cclxuXHRcdGlmKCFzKVxyXG5cdFx0XHR0aHJvdyBcIk5vIFN0YXRlIGZvdW5kIGZvciB1cmwgXCIrdXJsO1xyXG5cclxuXHRcdHJldHVybiBzO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSB1cmxGcm9tU3RhdGUodXJsOiBzdHJpbmcsIGFyZ3M6IGFueSk6IHN0cmluZyB7XHJcblx0XHRsZXQgcmVnZXggPSAvOihbXFx3XSspLztcclxuXHRcdHdoaWxlKHVybC5tYXRjaChyZWdleCkpIHtcclxuXHRcdFx0dXJsID0gdXJsLnJlcGxhY2UocmVnZXgsIGZ1bmN0aW9uKG0pIHtcclxuXHRcdFx0XHRyZXR1cm4gYXJnc1ttLnN1YnN0cigxKV07XHJcblx0XHRcdH0pO1xyXG5cdFx0fVxyXG5cdFx0cmV0dXJuIHVybDtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgZXF1YWxzKG8xOiBhbnksIG8yOiBhbnkpIDogYm9vbGVhbiB7XHJcblx0XHRyZXR1cm4gSlNPTi5zdHJpbmdpZnkobzEpID09PSBKU09OLnN0cmluZ2lmeShvMik7XHJcblx0fVxyXG5cclxufVxyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=