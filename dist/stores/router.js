var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") return Reflect.decorate(decorators, target, key, desc);
    switch (arguments.length) {
        case 2: return decorators.reduceRight(function(o, d) { return (d && d(o)) || o; }, target);
        case 3: return decorators.reduceRight(function(o, d) { return (d && d(target, key)), void 0; }, void 0);
        case 4: return decorators.reduceRight(function(o, d) { return (d && d(target, key, o)) || o; }, desc);
    }
};
var Promise = ho.promise.Promise;
var Router = (function (_super) {
    __extends(Router, _super);
    function Router() {
        _super.call(this);
        this.mapping = null;
        this.actions = ['RouterActions'];
        window.onhashchange = this.onHashChange.bind(this);
    }
    Router.prototype.init = function () {
        return ho.promise.Promise.create(this.onHashChange());
    };
    Router.prototype.onStateChangeRequested = function (data) {
        //get requested state
        var state = this.getStateFromName(data.state);
        var url = this.urlFromState(state.url, data.args);
        //current state and args equals requested state and args -> return
        if (this.data &&
            this.data.state &&
            this.data.state.name === data.state &&
            this.equals(this.data.args, data.args) &&
            url === window.location.hash.substr(1)) {
            return;
        }
        //requested state has an redirect property -> call redirect state
        if (!!state.redirect) {
            state = this.getStateFromName(state.redirect);
        }
        var prom = typeof state.before === 'function' ? state.before(data) : Promise.create(undefined);
        prom
            .then(function () {
            //does the state change request comes from extern e.g. url change in browser window ?
            var extern = !!data.extern;
            this.data = {
                state: state,
                args: data.args,
                extern: extern,
            };
            //------- set url for browser
            var url = this.urlFromState(state.url, data.args);
            this.setUrl(url);
            this.changed();
        }.bind(this), function (data) {
            this.onStateChangeRequested(data);
        }.bind(this));
    };
    Router.prototype.onHashChange = function () {
        var s = this.stateFromUrl(window.location.hash.substr(1));
        var data = {
            state: s.state,
            args: s.args,
            extern: true
        };
        ho.flux.ACTIONS.get(RouterActions).go(data);
    };
    Router.prototype.setUrl = function (url) {
        if (window.location.hash.substr(1) === url)
            return;
        var l = window.onhashchange;
        window.onhashchange = null;
        window.location.hash = url;
        window.onhashchange = l;
    };
    Router.prototype.getStateFromName = function (name) {
        return this.mapping.filter(function (s) {
            return s.name === name;
        })[0];
    };
    Router.prototype.regexFromUrl = function (url) {
        var regex = /:([\w]+)/;
        while (url.match(regex)) {
            url = url.replace(regex, "([^\/]+)");
        }
        return url + '$';
    };
    Router.prototype.argsFromUrl = function (pattern, url) {
        var r = this.regexFromUrl(pattern);
        var names = pattern.match(r).slice(1);
        var values = url.match(r).slice(1);
        var args = {};
        names.forEach(function (name, i) {
            args[name.substr(1)] = values[i];
        });
        return args;
    };
    Router.prototype.stateFromUrl = function (url) {
        var _this = this;
        var s = void 0;
        this.mapping.forEach(function (state) {
            if (s)
                return;
            var r = _this.regexFromUrl(state.url);
            if (url.match(r)) {
                var args = _this.argsFromUrl(state.url, url);
                s = {
                    "state": state.name,
                    "args": args,
                    "extern": false
                };
            }
        });
        if (!s)
            throw "No State found for url " + url;
        return s;
    };
    Router.prototype.urlFromState = function (url, args) {
        var regex = /:([\w]+)/;
        while (url.match(regex)) {
            url = url.replace(regex, function (m) {
                return args[m.substr(1)];
            });
        }
        return url;
    };
    Router.prototype.equals = function (o1, o2) {
        return JSON.stringify(o1) === JSON.stringify(o2);
    };
    Object.defineProperty(Router.prototype, "onStateChangeRequested",
        __decorate([
            ho.flux.Store.on('STATE')
        ], Router.prototype, "onStateChangeRequested", Object.getOwnPropertyDescriptor(Router.prototype, "onStateChangeRequested")));
    return Router;
})(ho.flux.Store);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN0b3Jlcy9yb3V0ZXIudHMiXSwibmFtZXMiOlsiUm91dGVyIiwiUm91dGVyLmNvbnN0cnVjdG9yIiwiUm91dGVyLmluaXQiLCJSb3V0ZXIub25TdGF0ZUNoYW5nZVJlcXVlc3RlZCIsIlJvdXRlci5vbkhhc2hDaGFuZ2UiLCJSb3V0ZXIuc2V0VXJsIiwiUm91dGVyLmdldFN0YXRlRnJvbU5hbWUiLCJSb3V0ZXIucmVnZXhGcm9tVXJsIiwiUm91dGVyLmFyZ3NGcm9tVXJsIiwiUm91dGVyLnN0YXRlRnJvbVVybCIsIlJvdXRlci51cmxGcm9tU3RhdGUiLCJSb3V0ZXIuZXF1YWxzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUNBLElBQU8sT0FBTyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDO0FBbUNwQztJQUFxQkEsMEJBQTBCQTtJQUs5Q0E7UUFDQ0MsaUJBQU9BLENBQUNBO1FBSkNBLFlBQU9BLEdBQWlCQSxJQUFJQSxDQUFDQTtRQUN2Q0EsWUFBT0EsR0FBR0EsQ0FBQ0EsZUFBZUEsQ0FBQ0EsQ0FBQ0E7UUFJM0JBLE1BQU1BLENBQUNBLFlBQVlBLEdBQUdBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO0lBQ3BEQSxDQUFDQTtJQUVNRCxxQkFBSUEsR0FBWEE7UUFDQ0UsTUFBTUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsWUFBWUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7SUFDdkRBLENBQUNBO0lBR1NGLHVDQUFzQkEsR0FEaENBLFVBQ2lDQSxJQUFnQkE7UUFDaERHLEFBQ0FBLHFCQURxQkE7WUFDakJBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFDOUNBLElBQUlBLEdBQUdBLEdBQUdBLElBQUlBLENBQUNBLFlBQVlB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Sm9CLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQXdKakMiLCJmaWxlIjoic3RvcmVzL3JvdXRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgUHJvbWlzZSA9IGhvLnByb21pc2UuUHJvbWlzZTtcclxuXHJcbmludGVyZmFjZSBJU3RhdGUge1xyXG5cdG5hbWU6IHN0cmluZztcclxuXHR1cmw6IHN0cmluZztcclxuXHRyZWRpcmVjdD86IHN0cmluZztcclxuXHRiZWZvcmU/OiAoZGF0YTogSVJvdXRlRGF0YSk9PlByb21pc2U8YW55LCBhbnk+O1xyXG5cdHZpZXc/OiBBcnJheTxJVmlld1N0YXRlPjtcclxufVxyXG5cclxuaW50ZXJmYWNlIElWaWV3U3RhdGUge1xyXG4gICAgbmFtZTogc3RyaW5nO1xyXG5cdGh0bWw/OiBzdHJpbmc7XHJcblx0Y29tcG9uZW50Pzogc3RyaW5nO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSVN0YXRlcyB7XHJcbiAgICBzdGF0ZXM6IEFycmF5PElTdGF0ZT47XHJcbn1cclxuXHJcblxyXG4vKiogRGF0YSB0aGF0IGEgUm91dGVyI2dvIHRha2VzICovXHJcbmludGVyZmFjZSBJUm91dGVEYXRhIHtcclxuICAgIHN0YXRlOiBzdHJpbmc7XHJcblx0YXJnczogYW55O1xyXG5cdGV4dGVybjogYm9vbGVhbjtcclxufVxyXG5cclxuLyoqIERhdGEgdGhhdCBSb3V0ZXIjY2hhbmdlcyBlbWl0IHRvIGl0cyBsaXN0ZW5lcnMgKi9cclxuaW50ZXJmYWNlIElSb3V0ZXJEYXRhIHtcclxuICAgIHN0YXRlOiBJU3RhdGU7XHJcblx0YXJnczogYW55O1xyXG5cdGV4dGVybjogYm9vbGVhbjtcclxufVxyXG5cclxuY2xhc3MgUm91dGVyIGV4dGVuZHMgaG8uZmx1eC5TdG9yZTxJUm91dGVyRGF0YT4ge1xyXG5cclxuXHRwcm90ZWN0ZWQgbWFwcGluZzpBcnJheTxJU3RhdGU+ID0gbnVsbDtcclxuXHRhY3Rpb25zID0gWydSb3V0ZXJBY3Rpb25zJ107XHJcblxyXG5cdGNvbnN0cnVjdG9yKCkge1xyXG5cdFx0c3VwZXIoKTtcclxuXHRcdHdpbmRvdy5vbmhhc2hjaGFuZ2UgPSB0aGlzLm9uSGFzaENoYW5nZS5iaW5kKHRoaXMpO1xyXG5cdH1cclxuXHJcblx0cHVibGljIGluaXQoKTogaG8ucHJvbWlzZS5Qcm9taXNlPGFueSwgYW55PiB7XHJcblx0XHRyZXR1cm4gaG8ucHJvbWlzZS5Qcm9taXNlLmNyZWF0ZSh0aGlzLm9uSGFzaENoYW5nZSgpKTtcclxuXHR9XHJcblxyXG5cdEBoby5mbHV4LlN0b3JlLm9uKCdTVEFURScpXHJcblx0cHJvdGVjdGVkIG9uU3RhdGVDaGFuZ2VSZXF1ZXN0ZWQoZGF0YTogSVJvdXRlRGF0YSk6IHZvaWQge1xyXG5cdFx0Ly9nZXQgcmVxdWVzdGVkIHN0YXRlXHJcblx0XHRsZXQgc3RhdGUgPSB0aGlzLmdldFN0YXRlRnJvbU5hbWUoZGF0YS5zdGF0ZSk7XHJcblx0XHRsZXQgdXJsID0gdGhpcy51cmxGcm9tU3RhdGUoc3RhdGUudXJsLCBkYXRhLmFyZ3MpO1xyXG5cclxuXHRcdC8vY3VycmVudCBzdGF0ZSBhbmQgYXJncyBlcXVhbHMgcmVxdWVzdGVkIHN0YXRlIGFuZCBhcmdzIC0+IHJldHVyblxyXG5cdFx0aWYoXHJcblx0XHRcdHRoaXMuZGF0YSAmJlxyXG5cdFx0XHR0aGlzLmRhdGEuc3RhdGUgJiZcclxuXHRcdFx0dGhpcy5kYXRhLnN0YXRlLm5hbWUgPT09IGRhdGEuc3RhdGUgJiZcclxuXHRcdFx0dGhpcy5lcXVhbHModGhpcy5kYXRhLmFyZ3MsIGRhdGEuYXJncykgJiZcclxuXHRcdFx0dXJsID09PSB3aW5kb3cubG9jYXRpb24uaGFzaC5zdWJzdHIoMSlcclxuXHRcdCkge1xyXG5cdFx0XHRyZXR1cm47XHJcblx0XHR9XHJcblxyXG5cclxuXHJcblx0XHQvL3JlcXVlc3RlZCBzdGF0ZSBoYXMgYW4gcmVkaXJlY3QgcHJvcGVydHkgLT4gY2FsbCByZWRpcmVjdCBzdGF0ZVxyXG5cdFx0aWYoISFzdGF0ZS5yZWRpcmVjdCkge1xyXG5cdFx0XHRzdGF0ZSA9IHRoaXMuZ2V0U3RhdGVGcm9tTmFtZShzdGF0ZS5yZWRpcmVjdCk7XHJcblx0XHR9XHJcblxyXG5cclxuXHRcdGxldCBwcm9tID0gdHlwZW9mIHN0YXRlLmJlZm9yZSA9PT0gJ2Z1bmN0aW9uJyA/IHN0YXRlLmJlZm9yZShkYXRhKSA6IFByb21pc2UuY3JlYXRlKHVuZGVmaW5lZCk7XHJcblx0XHRwcm9tXHJcblx0XHQudGhlbihmdW5jdGlvbigpIHtcclxuXHJcblx0XHRcdC8vZG9lcyB0aGUgc3RhdGUgY2hhbmdlIHJlcXVlc3QgY29tZXMgZnJvbSBleHRlcm4gZS5nLiB1cmwgY2hhbmdlIGluIGJyb3dzZXIgd2luZG93ID9cclxuXHRcdFx0bGV0IGV4dGVybiA9ICEhIGRhdGEuZXh0ZXJuO1xyXG5cclxuXHRcdFx0dGhpcy5kYXRhID0ge1xyXG5cdFx0XHRcdHN0YXRlOiBzdGF0ZSxcclxuXHRcdFx0XHRhcmdzOiBkYXRhLmFyZ3MsXHJcblx0XHRcdFx0ZXh0ZXJuOiBleHRlcm4sXHJcblx0XHRcdH07XHJcblxyXG5cdFx0XHQvLy0tLS0tLS0gc2V0IHVybCBmb3IgYnJvd3NlclxyXG5cdFx0XHR2YXIgdXJsID0gdGhpcy51cmxGcm9tU3RhdGUoc3RhdGUudXJsLCBkYXRhLmFyZ3MpO1xyXG5cdFx0XHR0aGlzLnNldFVybCh1cmwpO1xyXG5cclxuXHRcdFx0dGhpcy5jaGFuZ2VkKCk7XHJcblxyXG5cdFx0fS5iaW5kKHRoaXMpLFxyXG5cdFx0ZnVuY3Rpb24oZGF0YSkge1xyXG5cdFx0XHR0aGlzLm9uU3RhdGVDaGFuZ2VSZXF1ZXN0ZWQoZGF0YSk7XHJcblx0XHR9LmJpbmQodGhpcykpO1xyXG5cclxuXHR9XHJcblxyXG5cdHByb3RlY3RlZCBvbkhhc2hDaGFuZ2UoKTogdm9pZCB7XHJcblx0XHRsZXQgcyA9IHRoaXMuc3RhdGVGcm9tVXJsKHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cigxKSk7XHJcblxyXG5cdFx0bGV0IGRhdGEgPSB7XHJcblx0XHRcdHN0YXRlOiBzLnN0YXRlLFxyXG5cdFx0XHRhcmdzOiBzLmFyZ3MsXHJcblx0XHRcdGV4dGVybjogdHJ1ZVxyXG5cdFx0fTtcclxuXHJcblx0XHRoby5mbHV4LkFDVElPTlMuZ2V0KFJvdXRlckFjdGlvbnMpLmdvKGRhdGEpO1xyXG5cclxuXHR9XHJcblxyXG5cdHByaXZhdGUgc2V0VXJsKHVybDogc3RyaW5nKTogdm9pZCB7XHJcblx0XHRpZih3aW5kb3cubG9jYXRpb24uaGFzaC5zdWJzdHIoMSkgPT09IHVybClcclxuXHRcdFx0cmV0dXJuO1xyXG5cclxuXHRcdGxldCBsID0gd2luZG93Lm9uaGFzaGNoYW5nZTtcclxuXHRcdHdpbmRvdy5vbmhhc2hjaGFuZ2UgPSBudWxsO1xyXG5cdFx0d2luZG93LmxvY2F0aW9uLmhhc2ggPSB1cmw7XHJcblx0XHR3aW5kb3cub25oYXNoY2hhbmdlID0gbDtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgZ2V0U3RhdGVGcm9tTmFtZShuYW1lOiBzdHJpbmcpOiBJU3RhdGUge1xyXG5cdFx0cmV0dXJuIHRoaXMubWFwcGluZy5maWx0ZXIoKHMpPT57XHJcblx0XHRcdHJldHVybiBzLm5hbWUgPT09IG5hbWVcclxuXHRcdH0pWzBdO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSByZWdleEZyb21VcmwodXJsOiBzdHJpbmcpOiBzdHJpbmcge1xyXG5cdFx0dmFyIHJlZ2V4ID0gLzooW1xcd10rKS87XHJcblx0XHR3aGlsZSh1cmwubWF0Y2gocmVnZXgpKSB7XHJcblx0XHRcdHVybCA9IHVybC5yZXBsYWNlKHJlZ2V4LCBcIihbXlxcL10rKVwiKTtcclxuXHRcdH1cclxuXHRcdHJldHVybiB1cmwrJyQnO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBhcmdzRnJvbVVybChwYXR0ZXJuOiBzdHJpbmcsIHVybDogc3RyaW5nKTogYW55IHtcclxuXHRcdGxldCByID0gdGhpcy5yZWdleEZyb21VcmwocGF0dGVybik7XHJcblx0XHRsZXQgbmFtZXMgPSBwYXR0ZXJuLm1hdGNoKHIpLnNsaWNlKDEpO1xyXG5cdFx0bGV0IHZhbHVlcyA9IHVybC5tYXRjaChyKS5zbGljZSgxKTtcclxuXHJcblx0XHRsZXQgYXJncyA9IHt9O1xyXG5cdFx0bmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lLCBpKSB7XHJcblx0XHRcdGFyZ3NbbmFtZS5zdWJzdHIoMSldID0gdmFsdWVzW2ldO1xyXG5cdFx0fSk7XHJcblxyXG5cdFx0cmV0dXJuIGFyZ3M7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIHN0YXRlRnJvbVVybCh1cmw6IHN0cmluZyk6IElSb3V0ZURhdGEge1xyXG5cdFx0dmFyIHMgPSB2b2lkIDA7XHJcblx0XHR0aGlzLm1hcHBpbmcuZm9yRWFjaCgoc3RhdGU6IElTdGF0ZSkgPT4ge1xyXG5cdFx0XHRpZihzKVxyXG5cdFx0XHRcdHJldHVybjtcclxuXHJcblx0XHRcdHZhciByID0gdGhpcy5yZWdleEZyb21Vcmwoc3RhdGUudXJsKTtcclxuXHRcdFx0aWYodXJsLm1hdGNoKHIpKSB7XHJcblx0XHRcdFx0dmFyIGFyZ3MgPSB0aGlzLmFyZ3NGcm9tVXJsKHN0YXRlLnVybCwgdXJsKTtcclxuXHRcdFx0XHRzID0ge1xyXG5cdFx0XHRcdFx0XCJzdGF0ZVwiOiBzdGF0ZS5uYW1lLFxyXG5cdFx0XHRcdFx0XCJhcmdzXCI6IGFyZ3MsXHJcblx0XHRcdFx0XHRcImV4dGVyblwiOiBmYWxzZVxyXG5cdFx0XHRcdH07XHJcblx0XHRcdH1cclxuXHRcdH0pO1xyXG5cclxuXHRcdGlmKCFzKVxyXG5cdFx0XHR0aHJvdyBcIk5vIFN0YXRlIGZvdW5kIGZvciB1cmwgXCIrdXJsO1xyXG5cclxuXHRcdHJldHVybiBzO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSB1cmxGcm9tU3RhdGUodXJsOiBzdHJpbmcsIGFyZ3M6IGFueSk6IHN0cmluZyB7XHJcblx0XHRsZXQgcmVnZXggPSAvOihbXFx3XSspLztcclxuXHRcdHdoaWxlKHVybC5tYXRjaChyZWdleCkpIHtcclxuXHRcdFx0dXJsID0gdXJsLnJlcGxhY2UocmVnZXgsIGZ1bmN0aW9uKG0pIHtcclxuXHRcdFx0XHRyZXR1cm4gYXJnc1ttLnN1YnN0cigxKV07XHJcblx0XHRcdH0pO1xyXG5cdFx0fVxyXG5cdFx0cmV0dXJuIHVybDtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgZXF1YWxzKG8xOiBhbnksIG8yOiBhbnkpIDogYm9vbGVhbiB7XHJcblx0XHRyZXR1cm4gSlNPTi5zdHJpbmdpZnkobzEpID09PSBKU09OLnN0cmluZ2lmeShvMik7XHJcblx0fVxyXG5cclxufVxyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=